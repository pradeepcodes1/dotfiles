if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi


# Force Nix paths to front (Nix is sourced in /etc/zshrc before brew prepends)
if [ -e "$HOME/.nix-profile/bin" ]; then
  export PATH="$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:$PATH"
fi

# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"

# Initialize completion system
autoload -Uz compinit
compinit -C
setopt PROMPT_SUBST

# Enable JSON logging
export DOTFILES_JSON_LOG=1

# Source custom zsh files (lazy-load rarely used modules)
_lazy_modules=(cp.zsh backup.zsh log-viewer.zsh)
for file in "$HOME/.config/zsh/"*.zsh; do
  [ -f "$file" ] || continue
  local basename="${file:t}"
  if (( ${_lazy_modules[(Ie)$basename]} )); then
    continue  # skip, loaded via stubs below
  fi
  source "$file"
done
unset _lazy_modules

# Lazy-load stubs: source on first invocation
_lazy_source() {
  local file="$1"; shift
  for cmd in "$@"; do
    eval "${cmd}() { unfunction ${cmd} 2>/dev/null; source \"$file\"; ${cmd} \"\$@\" }"
  done
}
_lazy_source "$HOME/.config/zsh/cp.zsh" cpt
_lazy_source "$HOME/.config/zsh/backup.zsh" backup-system
_lazy_source "$HOME/.config/zsh/log-viewer.zsh" dotlog dotlog-stats dotlog-search dotlog-clean
unfunction _lazy_source

[[ -f "$HOME/.env" ]] && source "$HOME/.env"

command -v mise &>/dev/null && eval "$(mise activate zsh)"

# Enable vcs_info (colors set by theme.zsh)
autoload -Uz vcs_info
zstyle ':vcs_info:git:*' check-for-changes true
precmd() { vcs_info }

# Colorful man pages
export MANPAGER="sh -c 'col -bx | bat -l man -p'"

command -v direnv &>/dev/null && eval "$(direnv hook zsh)"

# Default to dev volume if available and at home
[[ "$PWD" == "$HOME" && -d "/Volumes/dev" ]] && cd /Volumes/dev
