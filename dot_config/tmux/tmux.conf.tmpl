# Prefix (Ctrl+l)
unbind C-b
set -g prefix C-l
bind C-l send-prefix

# Right Option + key bindings (via Karabiner sending prefix + key)
# Window management
bind c new-window -c "#{pane_current_path}"                          # ROpt+c: new window
bind \; previous-window                                              # ROpt+;: previous window
bind "'" next-window                                                 # ROpt+': next window
bind w choose-window                                                 # ROpt+w: choose window
bind 1 select-window -t :=1                                          # ROpt+1: window 1
bind 2 select-window -t :=2                                          # ROpt+2: window 2
bind 3 select-window -t :=3                                          # ROpt+3: window 3
bind 4 select-window -t :=4                                          # ROpt+4: window 4
bind 5 select-window -t :=5                                          # ROpt+5: window 5
bind 6 select-window -t :=6                                          # ROpt+6: window 6
bind 7 select-window -t :=7                                          # ROpt+7: window 7
bind 8 select-window -t :=8                                          # ROpt+8: window 8
bind 9 select-window -t :=9                                          # ROpt+9: window 9

# Pane management (h/j/k/l defined below)
bind z resize-pane -Z                                                # ROpt+z: zoom pane
bind x kill-pane                                                      # ROpt+x: kill pane

# Session management
bind d detach-client                                                 # ROpt+d: detach
bind s choose-session                                                # ROpt+s: choose session

# Copy mode
bind [ copy-mode                                                     # ROpt+[: copy mode
bind / run-shell 'tmux display-popup -E -w 80% -h 80% "{{ .chezmoi.targetFile | dir }}/relative-copy-mode.sh #{pane_id}"'  # ROpt+/: copy mode with relative line numbers

set -g mouse on
set -g focus-events on
set-window-option -g mode-keys vi
set -g default-terminal "screen-256color"
set -g status-position bottom
set -g status-justify right
set -g status-right ""

set -g status-left-length 100
set -g status-interval 15
set -g status-left ' #S | #{b:@pane_home}#{?@ssh_host, | #{@ssh_host},} '
set -g display-time 1000

# Source current theme (updated by theme.zsh to persist across tmux reloads)
run-shell 'tmux source-file ~/.config/tmux/themes/current.conf 2>/dev/null || tmux source-file ~/.config/tmux/themes/${_DOTFILES_THEME_NAME:-kanagawa-dragon}.conf 2>/dev/null || tmux source-file ~/.config/tmux/themes/kanagawa-dragon.conf'

# Disable titles/renaming
set -g automatic-rename off
set -g allow-rename off
set -g set-titles off

set -g history-limit 10000

# Window/pane numbering starts at 1
set -g base-index 1
setw -g pane-base-index 1
# Split panes (| horizontal, - vertical)
bind | split-window -h -p 40 -c "#{pane_current_path}"
bind - split-window -v -p 40 -c "#{pane_current_path}"
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux reloaded"

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
# Navigate panes with Vim keys (h,j,k,l)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Initialize TMUX plugin manager (keep at bottom)
run '~/.tmux/plugins/tpm/tpm'
bind b set-option -g status

# Fix C-k passthrough for ghostty
set -g terminal-features "ghostty:c-k"

# Kill session and switch/create new
bind-key X confirm-before -p "kill-session '#S'? (y/n)" "\
    kill-session \; \
    if-shell '[ -n \"$(tmux list-sessions)\" ]' \
        'switch-client -l' \
        'new-session' \
"
# Prevent auto-scroll on mouse selection in copy mode
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection

# Session cleanup hook
set-hook -g client-session-changed 'run-shell "{{ .chezmoi.targetFile | dir }}/session-cleaner.sh"'

# Ghostty integration
set-option -ga update-environment " TERM_PROGRAM"
set-hook -g pane-exited 'run-shell "{{ .chezmoi.targetFile | dir }}/ghostty-exit-handler.sh"'
