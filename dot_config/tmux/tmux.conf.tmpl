# Traditional prefix (Ctrl+l) - kept for compatibility
unbind C-b
set -g prefix C-l
bind C-a send-prefix

# Right Option + key bindings (via Karabiner sending prefix + key)
# Window management
bind c new-window -c "#{pane_current_path}"                          # ROpt+c: new window
bind \; previous-window                                              # ROpt+;: previous window
bind "'" next-window                                                 # ROpt+': next window
bind w choose-window                                                 # ROpt+w: choose window
bind 1 select-window -t :=1                                          # ROpt+1: window 1
bind 2 select-window -t :=2                                          # ROpt+2: window 2
bind 3 select-window -t :=3                                          # ROpt+3: window 3
bind 4 select-window -t :=4                                          # ROpt+4: window 4
bind 5 select-window -t :=5                                          # ROpt+5: window 5
bind 6 select-window -t :=6                                          # ROpt+6: window 6
bind 7 select-window -t :=7                                          # ROpt+7: window 7
bind 8 select-window -t :=8                                          # ROpt+8: window 8
bind 9 select-window -t :=9                                          # ROpt+9: window 9

# Pane management (h/j/k/l defined below)
bind z resize-pane -Z                                                # ROpt+z: zoom pane
bind x kill-pane                                                      # ROpt+x: kill pane

# Session management
bind d detach-client                                                 # ROpt+d: detach
bind s choose-session                                                # ROpt+s: choose session

# Copy mode
bind [ copy-mode                                                     # ROpt+[: copy mode

set -g mouse on
set-window-option -g mode-keys vi
set -g default-terminal "screen-256color"
set -g status-position bottom
set -g status-justify right
set -g status-right ""

set -g status-left-length 100
set -g status-interval 1
set -g status-left ' #S | #{b:@pane_home}#{?@ssh_host, | #{@ssh_host},} '
set -g display-time 1000

# Source current theme (updated by theme.zsh to persist across tmux reloads)
run-shell 'tmux source-file ~/.config/tmux/themes/current.conf 2>/dev/null || tmux source-file ~/.config/tmux/themes/${_DOTFILES_THEME_NAME:-kanagawa-dragon}.conf 2>/dev/null || tmux source-file ~/.config/tmux/themes/kanagawa-dragon.conf'

# set -g status off

##### Disable titles / renaming #####
set -g automatic-rename off
set -g allow-rename off
set -g set-titles off

# Increase history limit
set -g history-limit 10000

# Start window and pane numbering at 1, not 0
set -g base-index 1
setw -g pane-base-index 1
# Split panes using | and - (and open in the same directory)
bind | split-window -h -p 40 -c "#{pane_current_path}"
bind - split-window -v -p 40 -c "#{pane_current_path}"
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux reloaded"
unbind '"'
unbind %

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
# Navigate panes with Vim keys (h,j,k,l)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Other examples:
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'github_username/plugin_name#branch'
# set -g @plugin 'git@github.com:user/plugin'
# set -g @plugin 'git@bitbucket.com:user/plugin'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
# Search console output/scrollback buffer with fzf and copy selection to clipboard
#bind h display-popup -E  "tmux capture-pane -p -S - | fzf --reverse | pbcopy"
bind h display-popup -E  "{{ .chezmoi.targetFile | dir }}/tmux-fzf-search.sh"
bind b set-option -g status

# C-k for nvim is being blocked
set -g terminal-features "alacritty:c-k"

# A simpler keybind to kill the current session and switch or create a new one.
bind-key X confirm-before -p "kill-session '#S'? (y/n)" "\
    kill-session \; \
    if-shell '[ -n \"$(tmux list-sessions)\" ]' \
        'switch-client -l' \
        'new-session' \
"
# Copy mode + Mouse != scroll to output automatically (sometimes u select the wrong thing and it is annoying, to scroll to cmd use 'q')
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection

# Hook to handle session switching (kill old session if 1 window)
set-hook -g client-session-changed 'run-shell "{{ .chezmoi.targetFile | dir }}/session-cleaner.sh"'
