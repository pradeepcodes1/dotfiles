# Core theme functions

_detect_macos_theme() {
  if defaults read -g AppleInterfaceStyle &>/dev/null; then
    echo "dark"
  else
    echo "light"
  fi
}

# Extract a metadata field from a theme color file header comment
# Usage: _get_theme_field "color_file_path" "Field"
_get_theme_field() {
  grep "^# $2:" "$1" | cut -d: -f2- | tr -d ' '
}

_load_theme_colors() {
  local theme_name="$1"
  local color_file="$_DOTFILES_COLORS_DIR/${theme_name}.sh"

  [[ ! -f "$color_file" ]] && return 1

  source "$color_file"

  export _DOTFILES_THEME_NAME="$theme_name"
  export _DOTFILES_THEME_MODE=$(_get_theme_field "$color_file" "Mode")
  export _DOTFILES_THEME_TRANSPARENT=$(_get_theme_field "$color_file" "Transparent")

  [[ -n "$nvim_colorscheme" ]] && export _DOTFILES_NVIM_COLORSCHEME="$nvim_colorscheme"
  [[ -n "$nvim_lualine" ]] && export _DOTFILES_NVIM_LUALINE="$nvim_lualine"
  [[ -n "$nvim_background" ]] && export _DOTFILES_NVIM_BACKGROUND="$nvim_background"
  return 0
}

_get_available_themes() {
  for f in "$_DOTFILES_COLORS_DIR"/*.sh; do
    [[ -f "$f" ]] && basename "$f" .sh
  done
}

_theme_fzf_pick() {
  local filter="$1"
  local themes_list=()

  for theme in $(_get_available_themes); do
    local color_file="$_DOTFILES_COLORS_DIR/${theme}.sh"
    local mode=$(_get_theme_field "$color_file" "Mode")
    local current=""
    [[ "$theme" == "$_DOTFILES_THEME_NAME" ]] && current="*"

    if [[ "$filter" == "all" ]] || [[ "$filter" == "$mode" ]]; then
      themes_list+=("$current$theme [$mode]")
    fi
  done

  local selected
  selected=$(printf '%s\n' "${themes_list[@]}" | sort | fzf --prompt="Select theme: " --height=40% --reverse)

  if [[ -n "$selected" ]]; then
    local theme_name="${selected#\*}"
    echo "${theme_name%% \[*}"
  fi
}
