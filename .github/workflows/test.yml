name: Test Chezmoi Config

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  CI: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Record start time
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      # --- Install Nix ---
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      # --- Install bootstrap tools via nix (includes pass, gnupg) ---
      - name: Install bootstrap tools
        run: |
          nix profile install ./nix/bootstrap

      # --- Setup pass with dummy secrets ---
      - name: Setup pass with dummy secrets
        run: |
          # Create a GPG key for pass (non-interactive)
          cat > /tmp/gpg-key-config <<EOF
          %no-protection
          Key-Type: RSA
          Key-Length: 2048
          Name-Real: CI Test
          Name-Email: ci@test.local
          Expire-Date: 0
          %commit
          EOF
          gpg --batch --gen-key /tmp/gpg-key-config

          # Get the key ID
          KEY_ID=$(gpg --list-keys --keyid-format LONG ci@test.local | grep pub | awk '{print $2}' | cut -d'/' -f2)

          # Initialize pass
          pass init "$KEY_ID"

          # Insert dummy secrets for all pass paths used in templates
          echo "dummy-gemini-key" | pass insert -e api/ai/gemini
          echo "dummy-openrouter-key" | pass insert -e api/ai/openrouter
          echo "dummy-aws-secret" | pass insert -e aws/secret_key
          echo "dummy-aws-access" | pass insert -e aws/access_key
          echo "/tmp/dummy-restic-repo" | pass insert -e backups/restic-repo
          echo "/tmp/dummy-obsidian" | pass insert -e backups/obsidian
          echo "/tmp/dummy-yamtrack" | pass insert -e backups/yamtrack-db

          echo "âœ… Pass initialized with dummy secrets"

      # --- Install chezmoi ---
      - name: Install chezmoi
        run: nix profile install nixpkgs#chezmoi

      # --- Run chezmoi apply ---
      - name: Run chezmoi apply
        id: apply
        run: |
          chezmoi apply --source="${GITHUB_WORKSPACE}" 2>&1 | tee /tmp/chezmoi-apply.log
          exit ${PIPESTATUS[0]}

      # --- Summary ---
      - name: Calculate duration
        id: duration
        if: always()
        run: |
          END=$(date +%s)
          START=${{ steps.start.outputs.time }}
          DURATION=$((END - START))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "formatted=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Print summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Chezmoi Test Results

          | Metric | Value |
          |--------|-------|
          | Duration | ${{ steps.duration.outputs.formatted }} |
          | Branch | \`${{ github.ref_name }}\` |
          | Commit | \`${{ github.sha }}\` |
          | Status | \`${{ steps.apply.outcome }}\` |
          EOF

          if [ -f /tmp/chezmoi-apply.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Apply Log (last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/chezmoi-apply.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: List applied files
        if: always()
        run: |
          echo "::group::~/.config"
          ls -la ~/.config/ 2>/dev/null || echo "No .config"
          echo "::endgroup::"
          echo "::group::Home dotfiles"
          ls -la ~/ | grep '^\.' || true
          echo "::endgroup::"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chezmoi-logs
          path: /tmp/chezmoi-apply.log
          retention-days: 7
