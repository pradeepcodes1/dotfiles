name: Test Chezmoi Config

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  CI: true

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}
    name: Test on ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Record start time
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      # --- Install chezmoi (the only external install) ---
      - name: Install chezmoi
        run: sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin

      # --- Install nix (using the same script chezmoi would use) ---
      - name: Install nix
        run: |
          curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | \
            sh -s -- install --no-confirm

      # --- Setup pass with dummy secrets (inside nix shell with bootstrap tools) ---
      - name: Setup pass with dummy secrets
        shell: bash
        run: |
          # Source nix
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh

          # Run inside nix shell with bootstrap tools (pass, gnupg, etc.)
          nix shell ./nix/bootstrap --command bash -c '
            # Create a GPG key for pass (non-interactive)
            cat > /tmp/gpg-key-config <<EOF
          %no-protection
          Key-Type: RSA
          Key-Length: 2048
          Name-Real: CI Test
          Name-Email: ci@test.local
          Expire-Date: 0
          %commit
          EOF
            gpg --batch --gen-key /tmp/gpg-key-config

            # Get the key ID
            KEY_ID=$(gpg --list-keys --keyid-format LONG ci@test.local | grep pub | awk "{print \$2}" | cut -d"/" -f2)

            # Initialize pass
            pass init "$KEY_ID"

            # Insert dummy secrets
            echo "dummy-gemini-key" | pass insert -e api/ai/gemini
            echo "dummy-openrouter-key" | pass insert -e api/ai/openrouter
            echo "dummy-aws-secret" | pass insert -e aws/secret_key
            echo "dummy-aws-access" | pass insert -e aws/access_key
            echo "/tmp/dummy-restic-repo" | pass insert -e backups/restic-repo
            echo "/tmp/dummy-obsidian" | pass insert -e backups/obsidian
            echo "/tmp/dummy-yamtrack" | pass insert -e backups/yamtrack-db

            echo "âœ… Pass initialized with dummy secrets"
          '

      # --- Run chezmoi apply (nix shell provides pass for template rendering) ---
      - name: Run chezmoi apply
        id: apply
        shell: bash
        run: |
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
          nix shell ./nix/bootstrap --command bash -c '
            chezmoi apply --source="${GITHUB_WORKSPACE}" 2>&1 | tee /tmp/chezmoi-apply.log
            exit ${PIPESTATUS[0]}
          '

      # --- Summary ---
      - name: Calculate duration
        id: duration
        if: always()
        run: |
          END=$(date +%s)
          START=${{ steps.start.outputs.time }}
          DURATION=$((END - START))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "formatted=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Print summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Chezmoi Test Results (${{ matrix.os }})

          | Metric | Value |
          |--------|-------|
          | OS | \`${{ matrix.os }}\` |
          | Duration | ${{ steps.duration.outputs.formatted }} |
          | Branch | \`${{ github.ref_name }}\` |
          | Commit | \`${{ github.sha }}\` |
          | Status | \`${{ steps.apply.outcome }}\` |
          EOF

          if [ -f /tmp/chezmoi-apply.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Apply Log (last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/chezmoi-apply.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: List applied files
        if: always()
        run: |
          echo "::group::~/.config"
          ls -la ~/.config/ 2>/dev/null || echo "No .config"
          echo "::endgroup::"
          echo "::group::Home dotfiles"
          ls -la ~/ | grep '^\.' || true
          echo "::endgroup::"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chezmoi-logs-${{ matrix.os }}
          path: /tmp/chezmoi-apply.log
          retention-days: 7
