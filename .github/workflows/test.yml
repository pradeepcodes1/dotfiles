name: Test Chezmoi Config

on:
  pull_request:
    paths-ignore:
      - "**.md"
  workflow_dispatch:

env:
  CI: true

jobs:
  # Unit tests run first - fast, no bootstrap needed
  unit-tests:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}
    name: Unit tests on ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install test dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y zsh jq
          else
            brew install jq
          fi

      - name: Run unit tests
        id: unit_tests
        run: |
          ./tests/run_tests.sh 2>&1 | tee /tmp/unit-tests.log
          exit ${PIPESTATUS[0]}

      - name: Print summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Unit Test Results (${{ matrix.os }})

          | Metric | Value |
          |--------|-------|
          | OS | \`${{ matrix.os }}\` |
          | Branch | \`${{ github.ref_name }}\` |
          | Status | \`${{ steps.unit_tests.outcome }}\` |

          ### Test Output
          \`\`\`
          $(cat /tmp/unit-tests.log)
          \`\`\`
          EOF

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-logs-${{ matrix.os }}
          path: /tmp/unit-tests.log
          retention-days: 7

  bootstrap:
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}
    name: Bootstrap on ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Record start time
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      # --- Set up chezmoi config for CI (must happen before template evaluation) ---
      - name: Set up chezmoi config
        run: |
          mkdir -p ~/.config/chezmoi
          printf '[data.git]\nname = "CI Test"\nemail = "ci@test.local"\n' > ~/.config/chezmoi/chezmoi.toml

      # --- Run bootstrap (installs nix, runs chezmoi apply in nix shell) ---
      - name: Run bootstrap
        id: apply
        run: |
          ./bootstrap.sh 2>&1 | tee /tmp/chezmoi-apply.log
          exit ${PIPESTATUS[0]}

      # --- Summary ---
      - name: Calculate duration
        id: duration
        if: always()
        run: |
          END=$(date +%s)
          START=${{ steps.start.outputs.time }}
          DURATION=$((END - START))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "formatted=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Print summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Bootstrap Test Results (${{ matrix.os }})

          | Metric | Value |
          |--------|-------|
          | OS | \`${{ matrix.os }}\` |
          | Duration | ${{ steps.duration.outputs.formatted }} |
          | Branch | \`${{ github.ref_name }}\` |
          | Commit | \`${{ github.sha }}\` |
          | Status | \`${{ steps.apply.outcome }}\` |
          EOF

          if [ -f /tmp/chezmoi-apply.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Apply Log (last 50 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 /tmp/chezmoi-apply.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: List applied files
        if: always()
        run: |
          echo "::group::~/.config"
          ls -la ~/.config/ 2>/dev/null || echo "No .config"
          echo "::endgroup::"
          echo "::group::Home dotfiles"
          ls -la ~/ | grep '^\.' || true
          echo "::endgroup::"

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bootstrap-logs-${{ matrix.os }}
          path: /tmp/chezmoi-apply.log
          retention-days: 7

  integration-tests:
    needs: bootstrap
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}
    name: Integration tests on ${{ matrix.os }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Record start time
        id: start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      # --- Set up chezmoi config for CI (must happen before template evaluation) ---
      - name: Set up chezmoi config
        run: |
          mkdir -p ~/.config/chezmoi
          printf '[data.git]\nname = "CI Test"\nemail = "ci@test.local"\n' > ~/.config/chezmoi/chezmoi.toml

      # --- Run bootstrap (required for integration tests) ---
      - name: Run bootstrap
        id: apply
        run: |
          ./bootstrap.sh 2>&1 | tee /tmp/chezmoi-apply.log
          exit ${PIPESTATUS[0]}

      # --- Install integration test dependencies ---
      - name: Install test dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y zsh zoxide fzf fd-find jq
          else
            brew install zoxide fzf fd jq
          fi

      # --- Run integration tests via bats ---
      - name: Run integration tests
        id: integration_tests
        run: |
          ./tests/run_tests.sh -v 2>&1 | tee /tmp/integration-tests.log
          exit ${PIPESTATUS[0]}

      # --- Summary ---
      - name: Calculate duration
        id: duration
        if: always()
        run: |
          END=$(date +%s)
          START=${{ steps.start.outputs.time }}
          DURATION=$((END - START))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))
          echo "formatted=${MINUTES}m ${SECONDS}s" >> $GITHUB_OUTPUT

      - name: Print summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Integration Test Results (${{ matrix.os }})

          | Metric | Value |
          |--------|-------|
          | OS | \`${{ matrix.os }}\` |
          | Duration | ${{ steps.duration.outputs.formatted }} |
          | Branch | \`${{ github.ref_name }}\` |
          | Commit | \`${{ github.sha }}\` |
          | Bootstrap | \`${{ steps.apply.outcome }}\` |
          | Tests | \`${{ steps.integration_tests.outcome }}\` |
          EOF

          if [ -f /tmp/integration-tests.log ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/integration-tests.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-logs-${{ matrix.os }}
          path: |
            /tmp/chezmoi-apply.log
            /tmp/integration-tests.log
          retention-days: 7
