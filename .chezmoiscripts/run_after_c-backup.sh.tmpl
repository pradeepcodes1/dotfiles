#!/bin/bash
restic_backup() {
  export RESTIC_REPOSITORY="{{  pass "backups/restic-repo" }}"

  if (( $# == 0 )); then
    echo "Usage: restic_backup <path> [path ...]"
    return 2
  fi

  local SOURCES=("$@")

 echo "===== Backup started at $(date) ====="
 echo "Sources: ${SOURCES[*]}"

 for src in "${SOURCES[@]}"; do
   if [[ ! -e "$src" ]]; then
     echo "ERROR: Source does not exist: $src"
     return 1
   fi
 done

if ! restic snapshots --insecure-no-password >/dev/null 2>&1; then
  echo "Initializing restic repository..."
  if ! restic init --insecure-no-password; then
    echo "Failed to initialize repository. Exiting."
    exit 0
  fi
fi

 # ---- BACKUP ----
 echo "Running restic backup..."
 restic backup "${SOURCES[@]}" \
 --insecure-no-password \
   --exclude ".DS_Store" \
   --exclude ".Spotlight-V100" \
   --exclude ".Trashes"

 # ---- RETENTION ----
 echo "Applying retention policy..."
 restic forget \
     --insecure-no-password \
   --keep-daily 7 \
   --keep-weekly 4 \
   --keep-monthly 6 \
   --prune

 # ---- CHECK ----
 echo "Running restic check..."
 restic check --insecure-no-password

 echo "===== Backup finished at $(date) ====="
}


restic_backup \
     "{{  pass "backups/obsidian" }}" \
     "{{  pass "backups/yamtrack-db" }}"
