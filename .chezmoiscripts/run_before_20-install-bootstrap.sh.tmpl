#!/bin/bash
set -e

# Define bootstrap flake path
BOOTSTRAP_FLAKE="{{ .chezmoi.sourceDir }}/nix/bootstrap"

# Setup dummy pass for CI if not already configured
if [ -n "$CI" ] && [ ! -d "$HOME/.password-store" ]; then
  echo "üîß Setting up dummy pass for CI..."

  # We run the setup inside a nix shell to ensure gpg and pass are available
  # regardless of the host environment.
  nix shell "$BOOTSTRAP_FLAKE" --command bash -c "
    set -e
    echo 'üîë Generating GPG key...'
    cat > /tmp/gpg-key-config <<EOF
%no-protection
Key-Type: RSA
Key-Length: 2048
Name-Real: CI Test
Name-Email: ci@test.local
Expire-Date: 0
%commit
EOF
    gpg --batch --gen-key /tmp/gpg-key-config
    rm /tmp/gpg-key-config

    # Get the key ID
    KEY_ID=\$(gpg --list-keys --keyid-format LONG ci@test.local | grep pub | awk '{print \$2}' | cut -d'/' -f2)

    echo 'üîê Initializing pass with key: \$KEY_ID'
    pass init \"\$KEY_ID\"

    # Insert dummy secrets
    echo 'dummy-gemini-key' | pass insert -e api/ai/gemini
    echo 'dummy-openrouter-key' | pass insert -e api/ai/openrouter
    echo 'dummy-aws-secret' | pass insert -e aws/secret_key
    echo 'dummy-aws-access' | pass insert -e aws/access_key
    echo '/tmp/dummy-restic-repo' | pass insert -e backups/restic-repo
    echo '/tmp/dummy-obsidian' | pass insert -e backups/obsidian
    echo '/tmp/dummy-yamtrack' | pass insert -e backups/yamtrack-db
  "

  echo "‚úÖ Dummy pass initialized for CI"

else
  echo "‚ÑπÔ∏è  Skipping bootstrap profile installation (relying on nix shell execution)."
  
  if command -v pass >/dev/null 2>&1; then
    echo "‚úÖ pass is available in PATH"
  else
    echo "‚ö†Ô∏è  pass is NOT available in PATH. Templates using 'pass' may resolve to defaults."
  fi
fi
