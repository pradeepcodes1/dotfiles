#!/bin/bash
{{- $isCI := env "CI" }}
{{- $hasPass := and (lookPath "pass") (stat (joinPath .chezmoi.homeDir ".password-store")) }}
{{- if or $isCI (not $hasPass) }}
echo "Skipping backup (CI or pass not configured)"
exit 0
{{- else }}

# Load nix environment
if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
  . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi

restic_backup() {
  export RESTIC_REPOSITORY="{{ pass "backups/restic-repo" }}"

  if (( $# == 0 )); then
    echo "Usage: restic_backup <path> [path ...]"
    return 2
  fi

  local SOURCES=("$@")

if ! restic snapshots --insecure-no-password >/dev/null 2>&1; then
  echo "Initializing restic repository..."
  if ! restic init --insecure-no-password; then
    echo "Failed to initialize repository. Exiting."
    exit 0
  fi
fi

 echo "===== Backup started at $(date) ====="
 echo "Sources: ${SOURCES[*]}"

 for src in "${SOURCES[@]}"; do
   if [[ ! -e "$src" ]]; then
     echo "ERROR: Source does not exist: $src"
     return 1
   fi
 done


 # ---- BACKUP ----
 echo "Running restic backup..."
 restic backup "${SOURCES[@]}" \
 --insecure-no-password \
   --exclude ".DS_Store" \
   --exclude ".Spotlight-V100" \
   --exclude ".Trashes"

 # ---- RETENTION ----
 echo "Applying retention policy..."
 restic forget \
     --insecure-no-password \
   --keep-daily 7 \
   --keep-weekly 4 \
   --keep-monthly 6 \
   --prune

 # ---- CHECK ----
 echo "Running restic check..."
 restic check --insecure-no-password

 echo "===== Backup finished at $(date) ====="
}


restic_backup \
     "{{ pass "backups/obsidian" }}" \
     "{{ pass "backups/yamtrack-db" }}"
{{- end }}
