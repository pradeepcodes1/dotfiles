#!/bin/sh
set -e

# Load nix environment first
if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
  . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
elif [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi

# Function: Initialize brew environment
setup_brew_env() {
  if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi
}

setup_brew_env

# Check if brew is available
if command -v brew >/dev/null 2>&1; then
  echo "‚úÖ Running brew bundle..."
  brew bundle --file="$HOME/.config/brew/packages"
elif [ -x "/opt/homebrew/bin/brew" ]; then
  echo "‚úÖ Running brew bundle..."
  /opt/homebrew/bin/brew bundle --file="$HOME/.config/brew/packages"
else
  echo "‚ö†Ô∏è  Homebrew not found, skipping brew bundle"
fi

# Install main nix profile (if not already installed)
if command -v nix >/dev/null 2>&1; then
  FLAKE_PATH="{{ .chezmoi.sourceDir }}/nix/default"
  profiles=$(nix profile list 2>/dev/null || true)

  if ! echo "$profiles" | grep -q "pradeep-cli"; then
    echo "üì¶ Installing nix profile from $FLAKE_PATH..."
    nix profile install "$FLAKE_PATH"
  else
    echo "‚úÖ Nix profile already installed"
  fi

  # Upgrade profiles
  echo "üì¶ Upgrading nix profiles..."
  nix profile upgrade '.*' 2>/dev/null || true
else
  echo "‚ö†Ô∏è  Nix not found, skipping nix packages"
fi
