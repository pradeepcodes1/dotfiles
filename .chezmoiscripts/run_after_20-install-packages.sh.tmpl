#!/bin/sh
set -e

# Function: Initialize brew environment
setup_brew_env() {
  if [ -x "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [ -x "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  fi
}

# Setup brew environment first (in case PATH isn't set)
setup_brew_env

# Check if brew is available (either via PATH or at known locations)
if command -v brew >/dev/null 2>&1; then
  echo "✅ Running brew bundle..."
  brew bundle --file="$HOME/.config/brew/packages"
elif [ -x "/opt/homebrew/bin/brew" ]; then
  echo "✅ Running brew bundle..."
  /opt/homebrew/bin/brew bundle --file="$HOME/.config/brew/packages"
else
  echo "⚠️  Homebrew not found, skipping brew bundle"
fi

# Install packages from nix flake (if not already installed)
FLAKE_PATH="{{ .chezmoi.sourceDir }}/nix/default"
profiles=$(nix profile list 2>/dev/null || true)
if ! echo "$profiles" | grep -q "pradeep-cli"; then
  echo "Installing nix profile from $FLAKE_PATH..."
  nix profile install "$FLAKE_PATH" --verbose
fi

# Upgrade the profile
echo "Upgrading nix profiles..."
nix profile upgrade '.*' --verbose 2>/dev/null || true
